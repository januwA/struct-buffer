!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.StructBuffer=e():t.StructBuffer=e()}(this,(function(){return(()=>{"use strict";var t={d:(e,s)=>{for(var n in s)t.o(s,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:s[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{BOOL:()=>et,BYTE:()=>st,CHAR:()=>ut,CStruct:()=>n,DOUBLE:()=>ct,DWORD:()=>rt,FLOAT:()=>ot,INT:()=>dt,LONG:()=>pt,LONGLONG:()=>yt,QWORD:()=>it,SHORT:()=>ht,Struct:()=>Bt,StructBuffer:()=>O,TEXT:()=>g,UCHAR:()=>at,UINT:()=>lt,ULONG:()=>gt,ULONGLONG:()=>bt,USHORT:()=>ft,WORD:()=>nt,bits:()=>S,bool:()=>v,calcsize:()=>Dt,char:()=>B,createDataView:()=>o,display:()=>Lt,double:()=>F,float:()=>P,int:()=>I,int16_t:()=>Y,int32_t:()=>M,int64_t:()=>q,int8_t:()=>Q,iter_unpack:()=>zt,long:()=>H,longlong:()=>W,makeDataView:()=>c,pack:()=>kt,pack_into:()=>Et,padding_t:()=>D,registerType:()=>E,sbytes:()=>h,sbytes2:()=>l,short:()=>C,sizeof:()=>y,string_t:()=>z,sview:()=>p,typedef:()=>j,uchar:()=>R,uint:()=>$,uint16_t:()=>J,uint32_t:()=>Z,uint64_t:()=>tt,uint8_t:()=>X,ulong:()=>V,ulonglong:()=>K,unpack:()=>jt,unpack_from:()=>St,ushort:()=>G});var s={};t.r(s),t.d(s,{BOOL:()=>et,BYTE:()=>st,CHAR:()=>ut,DOUBLE:()=>ct,DWORD:()=>rt,FLOAT:()=>ot,INT:()=>dt,LONG:()=>pt,LONGLONG:()=>yt,QWORD:()=>it,SHORT:()=>ht,UCHAR:()=>at,UINT:()=>lt,ULONG:()=>gt,ULONGLONG:()=>bt,USHORT:()=>ft,WORD:()=>nt,bool:()=>v,char:()=>B,double:()=>F,float:()=>P,int:()=>I,int16_t:()=>Y,int32_t:()=>M,int64_t:()=>q,int8_t:()=>Q,long:()=>H,longlong:()=>W,padding_t:()=>D,short:()=>C,string_t:()=>z,uchar:()=>R,uint:()=>$,uint16_t:()=>J,uint32_t:()=>Z,uint64_t:()=>tt,uint8_t:()=>X,ulong:()=>V,ulonglong:()=>K,ushort:()=>G});var n={};function r(t,e,s=!1){let n=t;s&&"string"==typeof n&&(n=n.split(""));for(let t=e.length-1;t>=1;t--){const r=t===e.length-1,i=e[t];n=n.reduce(((t,e,s)=>(s%i==0&&t.push([]),t[t.length-1].push(e),t)),[]),s&&r&&(n=n.map((t=>t.join(""))))}return n}function i(t,e,s){for(;e-- >0;)t.setUint8(s++,0)}function o(t,e){return e||new DataView(new ArrayBuffer(t))}function c(t){if(t instanceof DataView)return t;if(Array.isArray(t)&&(t=Uint8Array.from(t)),!ArrayBuffer.isView(t))throw new Error(`Type Error: (${t}) is not an ArrayBuffer!!!`);return new DataView(t.buffer)}function u(t,e){return new Proxy(t,{get:(t,s)=>s in t?t[s]:/\d+/.test(s.toString())?e(t,parseInt(s)):void 0})}function a(t){const e=u(t,((t,s)=>(t.deeps.push(s),e)));return e}function h(t){return(t=t.replace(/0x|h|\\x|\s/gi,"")).length%2!=0&&(t=t.slice(0,-1)),t=t.replace(/([0-9a-f]{2})(?=[0-9a-f])/gi,"$1 "),new DataView(Uint8Array.from(t.split(/\s+/).map((t=>parseInt(t,16)))).buffer)}t.r(n),t.d(n,{defaultTypes:()=>mt,from:()=>_t,parse:()=>wt});const f=/^(0x([0-9a-f]{1,2})|([0-9a-f]{1,2})h|\\x([0-9a-f]{1,2}))/i,d=/0x([0-9a-f]{1,2})|([0-9a-f]{1,2})h|\\x([0-9a-f]{1,2})/i;function l(t,e=new TextEncoder){let s;const n=[];for(;t.length;)if(s=t.match(f),s&&s[1]){const e=s[2]??s[3]??s[4]??0;n.push(parseInt(e,16)),t=t.substr(s[1].length)}else if(t.length){const s=t.search(d);if(s<0)n.push(...e.encode(t)),t="";else{const r=t.substr(0,s);n.push(...e.encode(r)),t=t.substr(s)}}return new DataView(Uint8Array.from(n).buffer)}function p(t){const e=c(t),s=[];for(let t=0;t<e.byteLength;t++)s.push(e.getUint8(t).toString(16).padStart(2,"0"));return s.join(" ")}function g(t,e,s){const n=c(t);e||s?(void 0!==e&&"string"==typeof e||"function"==typeof e)&&(s=e,e=new TextDecoder):e=new TextDecoder;let r=0,i="",o=[];for(;;)try{const t=n.getUint8(r++);t>=32?o.push(t):(o.length&&(i+=e.decode(Uint8Array.from(o)),o=[]),i+=s?"string"==typeof s?s:s(t):".")}catch(t){o.length&&(i+=e.decode(Uint8Array.from(o)));break}return i}function y(t){if(t instanceof O){let e=0;const s=t.maxSize,n=b(t,1);for(;(n+e++)%s;);return(n+e-1)*t.count}return t.isList?t.size*t.count:t.size}function b(t,e){return Object.values(t.struct).reduce(((t,e)=>t+(e instanceof O?e.byteLength:y(e))),0)*(e??t.count)}class m{constructor(t,e,s){return this.structName=e,this.struct=s,this.deeps=[],this.deeps.push(t),a(this)}}class O extends Array{constructor(t,e){return super(),this.structName=t,this.struct=e,this.deeps=[],this.textDecode=new TextDecoder,this.textEncoder=new TextEncoder,this.structKV=Object.entries(e),u(this,((t,e)=>{const s=new m(e,t.structName,t.struct);return s.textDecode=t.textDecode,s.textEncoder=t.textEncoder,s.structKV=t.structKV,Object.setPrototypeOf(s,O.prototype),s}))}get isList(){return!!this.deeps.length}get count(){return this.deeps.reduce(((t,e)=>t*e),1)}get byteLength(){return b(this)}get maxSize(){return Math.max(...Object.values(this.struct).map((t=>t instanceof O?t.maxSize:t.size)))}decode(t,e=!1,s=0){t=c(t);const n=[];let i=this.count;for(;i--;){const r=this.structKV.reduce(((n,[r,i])=>(i instanceof O?(n[r]=i.decode(t,e,s),s+=i.byteLength):(n[r]=i.decode(t,e,s,this.textDecode),s+=y(i)),n)),{});n.push(r)}return this.isList?r(n,this.deeps):n[0]}encode(t,e=!1,s=0,n){const r=o(this.byteLength,n);this.isList&&Array.isArray(t)&&(t=t.flat());for(let n=0;n<this.count;n++){const o=this.isList?t[n]:t;if(void 0!==o)this.structKV.reduce(((t,[n,r])=>{const i=o[n];return r instanceof O?(r.encode(i,e,s,t),s+=r.byteLength):(r.encode(i,e,s,t,this.textEncoder),s+=y(r)),t}),r);else{const t=this.byteLength/this.count;i(r,t,s),s+=t}}return r}}const w="float",_="double",L={1:{1:"getUint8",0:"getInt8"},2:{1:"getUint16",0:"getInt16"},4:{1:"getUint32",0:"getInt32"},8:{1:"getBigUint64",0:"getBigInt64"},f:"getFloat32",d:"getFloat64"};class N{constructor(t,e,s,n,r,i){return this.names=e,this.size=s,this.unsigned=n,this.get=r,this.set=i,this.deeps=[],this.deeps.push(t),a(this)}}class x extends Array{constructor(t,e,s,n){super(),this.size=e,this.unsigned=s,this.KlassType=n,this.deeps=[],this.names=Array.isArray(t)?t:[t];const[r,i]=function(t){let e;const s=t.isName(w.toLowerCase())||t.isName(w.toUpperCase()),n=t.isName(_.toLowerCase())||t.isName(_.toUpperCase());if(s&&(e=L.f),n&&(e=L.d),e||(e=L[t.size][+t.unsigned]),!e)throw new Error(`StructBuffer: Unrecognized ${t} type.`);return[e,e.replace(/^(g)/,"s")]}(this);return this.set=i,this.get=r,u(this,((t,e)=>{const s=new N(e,t.names,t.size,t.unsigned,t.get,t.set);return t.bits&&(s.bits=t.bits),Object.setPrototypeOf(s,this.KlassType?this.KlassType.prototype:x.prototype),s}))}get isList(){return!!this.deeps.length}get count(){return this.deeps.reduce(((t,e)=>t*e),1)}is(t){return t.names.some((t=>this.names.includes(t)))}isName(t){return this.names.includes(t)}decode(t,e=!1,s=0){t=c(t);const n=[];let i=this.count;for(;i--;)n.push(t[this.get](s,e)),s+=this.size;return this.isList?r(n,this.deeps,!1):n[0]}encode(t,e=!1,s=0,n){const r=o(this.count*this.size,n);this.isList&&Array.isArray(t)&&(t=t.flat());for(let n=0;n<this.count;n++){const i=(this.isList?t[n]:t)??0;try{r[this.set](s,i,e)}catch(t){r[this.set](s,BigInt(i),e)}s+=this.size}return r}}class A extends x{constructor(t,e){super("<bits>",t,!0,A),this.bits=e}decode(t,e=!1,s=0){const n=super.decode(t,e,s);if(this.isList&&Array.isArray(n))return n.map((t=>{const e={};return Object.entries(this.bits).forEach((([s,n])=>{e[s]=(t&1<<n)>>n})),e}));{const t={};return Object.entries(this.bits).forEach((([e,s])=>{t[e]=(n&1<<s)>>s})),t}}encode(t,e=!1,s=0,n){const r=o(this.count*this.size,n);if(this.isList&&Array.isArray(t)){for(let n=0;n<this.count;n++){let i=0;Object.entries(t[n]).forEach((([t,e])=>{const s=this.bits[t];void 0!==s&&(i|=e<<s)})),r[this.set](s,i,e),s+=this.size}return r}{let n=0;return Object.entries(t).forEach((([t,e])=>{const s=this.bits[t];void 0!==s&&(n|=e<<s)})),r[this.set](s,n,e),r}}}class U extends x{constructor(t,e){super(t,e.size,e.unsigned,U)}decode(t,e=!1,s=0){let n=super.decode(t,e,s);return Array.isArray(n)?(n=n.flat().map((t=>Boolean(t))),n=r(n,this.deeps)):n=Boolean(n),n}encode(t,e=!1,s=0,n){return t&&Array.isArray(t)?t=t.flat().map((t=>Number(Boolean(t)))):t&&(t=Number(Boolean(t))),super.encode(t,e,s,n)}}class T extends x{constructor(){super("string_t",1,!0,T)}decode(t,e=!1,s=0,n){t=c(t),n||(n=new TextDecoder);const i=[];let o=this.count;for(;o--;){let r=t[this.get](s,e);if(0===r)break;r=n.decode(new Uint8Array([r])),i.push(r),s+=this.size}return this.deeps.length<2?i.join(""):this.isList?r(i,this.deeps,!0):i[0]}encode(t,e=!1,s=0,n,r){const i=o(this.count*this.size,n);Array.isArray(t)&&(t=t.flat().join("")),r||(r=new TextEncoder);const c=r.encode(t);for(let t=0;t<this.count;t++){const n=c[t]??0;try{i[this.set](s,n,e)}catch(t){i[this.set](s,BigInt(n),e)}s+=this.size}return i}}class k extends x{constructor(){super("padding_t",1,!0,k)}decode(t,e=!1,s=0){t=c(t);let n=y(this);const r=[];for(;n--;)r.push(t[this.get](s,e)),s++;return r}encode(t=0,e=!1,s=0,n){const r=o(this.count*this.size,n);"number"!=typeof t&&(t=0);let i=y(this);for(;i-- >0;)r.setUint8(s++,t);return r}}function E(t,e,s=!0){return new x(t,e,s)}function j(t,e){return E(t,e.size,e.unsigned)}function S(t,e){return new A(t.size,e)}const z=new T,D=new k,B=E(["char","signed char"],1,!1),v=new U("bool",B),R=E("unsigned char",1),C=E(["short","short int","signed short","signed short int"],2,!1),G=E(["unsigned short","unsigned short int"],2),I=E(["int","signed","signed int"],4,!1),$=E(["unsigned","unsigned int"],4),H=E(["long","long int","signed long","signed long int"],4,!1),V=E(["unsigned long","unsigned long int"],4),W=E(["long long","long long int","signed long long","signed long long int"],8,!1),K=E(["unsigned long long","unsigned long long int"],8),P=E(w,4),F=E([_,"long double"],8),Q=j(["int8_t","__int8"],B),Y=j(["int16_t","__int16"],C),M=j(["int32_t","__int32"],I),q=j(["int64_t","__int64"],W),X=j(["uint8_t","unsigned __int8"],R),J=j(["uint16_t","unsigned __int16"],G),Z=j(["uint32_t","unsigned __int32"],$),tt=j(["uint64_t","unsigned __int64"],K),et=new U("BOOL",I),st=j("BYTE",R),nt=j("WORD",G),rt=j("DWORD",V),it=E("QWORD",8),ot=j(w.toUpperCase(),P),ct=j(_.toUpperCase(),F),ut=j("CHAR",B),at=j("UCHAR",R),ht=j("SHORT",C),ft=j("USHORT",G),dt=j("INT",I),lt=j("UINT",$),pt=j("LONG",H),gt=j("ULONG",V),yt=j("LONGLONG",W),bt=j("ULONGLONG",K),mt=s,Ot=/\s*(?<typedef>typedef)?\s*(?<struct>struct)\s*(?<structName>\w+)\s*{(?<props>[^}]*)}(\s*(?<aliasName1>\w+)?\s*,\s*(?<aliasName2>\*\w+)?\s*;\s*)?/gi;function wt(t,e){e=Object.assign(mt,e);const s=[...(t=t.replace(/\/\/[^]*?\n|\/\*[^]*\*\//g,"")).matchAll(Ot)];if(!s||!s.length)throw new Error("[parseCStruct]: parse error");const n={};for(const t of s){const e=t.groups;if(!e?.struct)throw new Error('[parseCStruct]: Undefined identifier "struct"');const s=e?.aliasName1??e?.structName;if(!s)throw new Error('[parseCStruct]: You need to create a name for "struct"');const r={};e.props&&e.props.trim()&&e.props.trim().split(/\n/).map((t=>{const e=t.trim().replace(/;$/,"").split(/\s+/).map((t=>t.trim()));let s=e.pop(),n=e.join(" "),r=1,i=!1;const o=s.match(/\[(\d+)+\]/);return o&&(s=s.substr(0,o.index),r=parseInt(o[1])||1,i=!0),{type:n,name:s,count:r,isList:i}})).forEach((t=>{r[t.name]=t})),n[s]=r}const r=Object.keys(n).reduce(((t,e)=>Object.assign(t,{[e]:null})),{});for(const[t,s]of Object.entries(n))r[t]=new O(t,Object.entries(s).reduce(((t,[s,i])=>{if(i.type in n)return t[s]=r[i.type],t;if(!e)return t;let o=e[i.type];if(o||(o=Object.values(e).find((t=>{if(t instanceof x&&t.isName(i.type))return t}))),!o)throw new Error(`[parseCStruct]: The (${i.type}) type was not found in styles`);return t[s]=i.isList?o[i.count]:o,t}),{}));return r}function _t(t){let e="";for(let[s,n]of Object.entries(t.struct)){const t=n instanceof x?z.is(n)?B.names[0]:n.names[0]:n.structName;n.isList&&(s=`${s}${n.deeps.map((t=>`[${t}]`)).join("")}`),e+=`\t${t} ${s};\n`}return`\ntypedef struct _${t.structName}\n{\n${e.replace(/\n$/,"")}\n} ${t.structName}, *${t.structName};\n`}function Lt(t,e,s){s=Object.assign({hex:!0,littleEndian:!1},s);let n=0;const r=[];for(;;)try{let i=t[e.get](n,s.littleEndian);s.hex&&(i=i.toString(16).toUpperCase().padStart(2*e.size,"0")),r.push({offset:n,value:i}),n+=e.size}catch(t){break}return r}const Nt=[">","<","!"],xt=/^(\d+)(?=\w|\?)/i;function At(t){let e;const s=[];for(;t.length;){e=t.match(xt);let n=1;switch(e&&e[1]&&(n=parseInt(e[1]),t=t.substr(e[1].length)),t[0]){case"x":s.push(D[n]);break;case"c":case"b":s.push(B[n]);break;case"B":s.push(R[n]);break;case"?":s.push(v[n]);break;case"h":s.push(C[n]);break;case"H":s.push(G[n]);break;case"i":case"n":s.push(I[n]);break;case"I":case"N":s.push($[n]);break;case"l":s.push(H[n]);break;case"L":s.push(V[n]);break;case"q":s.push(W[n]);break;case"Q":s.push(K[n]);break;case"e":case"f":s.push(P[n]);break;case"d":s.push(F[n]);break;case"s":case"p":s.push(z[n]);break;default:throw new Error(`没有(${t[0]})格式!`)}t=t.substr(1)}return s}function Ut(t){switch(t){case">":case"!":return!1;case"<":return!0;default:throw new Error("错误的字节序")}}function Tt(t,e){t=t.replace(/\s/g,"");let s=Nt[0];return Nt.includes(t[0])&&(s=t[0],t=t.substr(1)),{littleEndian:Ut(s),view:c(e),types:At(t)}}function kt(t,...e){return Et(t,o(Dt(t)),0,...e)}function Et(t,e,s,...n){const{littleEndian:r,types:i,view:o}=Tt(t,e);for(;i.length;){const t=i.shift();if(!t)break;if(t.is(D))t.encode(0,r,s,o);else if(t.is(z))t.encode(n.shift(),r,s,o);else{const e=[];for(let s=0;s<t.count;s++)e.push(n.shift());t.encode(e,r,s,o)}s+=y(t)}return o}function jt(t,e,s=0){const{littleEndian:n,types:r,view:i}=Tt(t,e),o=[];for(;r.length;){const t=r.shift();if(!t)break;t.is(D)||o.push(t.decode(i,n,s)),s+=y(t)}return o.flat()}function St(t,e,s=0){return jt(t,e,s)}function zt(t,e){const s=Dt(t);let n=0;return{next(){try{return{value:jt(t,e,n),done:!(n+=s)}}catch(t){return{value:null,done:!0}}},[Symbol.iterator](){return this}}}function Dt(t){return t=t.replace(/\s/g,""),Nt.includes(t[0])&&(t=t.substr(1)),At(t).reduce(((t,e)=>t+y(e)),0)}class Bt{constructor(t){this.format=t,this.size=Dt(t)}pack(...t){return Et(this.format,o(this.size),0,...t)}pack_into(t,e,...s){return Et(this.format,t,e,...s)}unpack(t,e=0){return jt(this.format,t,e)}unpack_from(t,e=0){return jt(this.format,t,e)}iter_unpack(t){return zt(this.format,t)}}return e})()}));